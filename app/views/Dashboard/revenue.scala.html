@(title: String)

@main(title = title) {

    <h1 class="page-header">@title</h1>

    <div class="row">
        <div class="col-md-2">
            <dl>
                <dd><h2 class="top-none"><small>Revenue to date</small></h2></dd>
                <dt><h3 id="revenueMetric"></h3></dt>

                <dd><h2 class="top-none"><small>Revenue this period</small></h2></dd>
                <dt><h3 id="revenuePeriodMetric"></h3></dt>

                <dd><h2><small>WoW</small></h2></dd>
                <dt><h3 id="revenueWoW"></h3></dt>

                <dd><h2><small>MoM</small></h2></dd>
                <dt><h3 id="revenueMoM"></h3></dt>
            </dl>
        </div>
        <div class="col-md-10 top-spaced">
            <div id="revenueHistogram" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        </div>
    </div>

    <div class="row top-spaced">
        <div class="col-md-8">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Age Demographic</th>
                        <th>Male</th>
                        <th>Female</th>
                    </tr>
                </thead>
                <tbody id="revenueDemographicsTable"></tbody>
            </table>
        </div>
        <div class="col-md-4">
            <div id="revenueDemographicsPie"></div>
        </div>
    </div>

    <div class="row top-spaced">
        <div class="col-md-12">
            <div id="revenueLocation"></div>
        </div>
    </div>

    <script type="text/javascript">
        (function() {
            $(function () {
                var chart = new Highcharts.Map({
                    chart: {
                        renderTo: $('#revenueLocation')[0]
                    },

                    legend: {
                        enabled: false
                    },

                    series : [{
            // Use the gb-all map with no data as a basemap
            mapData: Highcharts.maps['custom/gb-all-ireland'],
            name: 'Basemap',
            borderColor: Highcharts.getOptions().colors[0],
            nullColor: '#fff',
        }, {
                        type: 'mappoint',
                        name: 'Cities',
                        color: Highcharts.getOptions().colors[1],
                        data: [{
                            name: 'London',
                            lat: 51.507222,
                            lon: -0.1275
                        }, {
                            name: 'Birmingham',
                            lat: 52.483056,
                            lon: -1.893611
                        }, {
                            name: 'Leeds',
                            lat: 53.799722,
                            lon: -1.549167
                        }, {
                            name: 'Glasgow',
                            lat: 55.858,
                            lon: -4.259
                        }, {
                            name: 'Sheffield',
                            lat: 53.383611,
                            lon: -1.466944
                        }, {
                            name: 'Liverpool',
                            lat: 53.4,
                            lon: -3
                        }, {
                            name: 'Bristol',
                            lat: 51.45,
                            lon: -2.583333
                        }, {
                            name: 'Belfast',
                            lat: 54.597,
                            lon: -5.93
                        }, {
                            name: 'Lerwick',
                            lat: 60.155,
                            lon: -1.145,
                            dataLabels: {
                                align: 'left',
                                x: 5,
                                verticalAlign: 'middle'
                            }
                        }]
                    }]
                });
            });
        })();

        (function() {
            var endpoint = '/revenue/histogram';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(data) {
                    $('#revenueHistogram').highcharts('StockChart', {
                        navigator : {
                            enabled : false
                        },

                        rangeSelector : {
                            enabled : false
                        },

                        scrollbar : {
                            enabled : false
                        },

                        yAxis: {
                            min: 0
                        },

                        series : [{
                            type : 'area',
                            data: data.data,
                            fillColor : {
                                linearGradient : {
                                    x1: 0,
                                    y1: 0,
                                    x2: 0,
                                    y2: 1
                                },
                                stops : [
                                    [0, Highcharts.getOptions().colors[0]],
                                    [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0.1).get('rgba')]
                                ]
                            }
                        }]
                    });
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/metric/1/2';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(data) {
                    $('#revenueMetric').html("&pound;" + data.data);
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/wow/1/2';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(num) {

                    if (num > 0) {
                        num = "+" + num
                    }

                    $('#revenueWoW').html(num + "%");
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/mom/1/2';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(num) {

                    if (num > 0) {
                        num = "+" + num
                    }

                    $('#revenueMoM').html(num + "%");
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/demographics';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(data) {
                    var colors = Highcharts.getOptions().colors;
                    var fragment = document.createDocumentFragment();

                    var splitData = [];

                    var parsedData = data[data.length-1].map(function(row, idx) {

                        for (var i in row) {
                            if (row.hasOwnProperty(i)) {
                                splitData.push({
                                    name: (i === "man" ? "Men" : "Women"),
                                    y: row[i].revenue,
                                    color: colors[idx]
                                })
                            }
                        }

                        return {
                            name: row["man"].range,
                            y: row["man"].revenue + row["woman"].revenue,
                            color: colors[idx]
                        }
                    })

                    var periodRevenue = 0;

                    parsedData.map(function(item) {
                        periodRevenue += item.y;
                    })

                    $('#revenuePeriodMetric').html('&pound;'+periodRevenue);

                    var tableData = data[data.length-1];

                    tableData.map(function(row, idx) {
                        var rowData = fragment.appendChild( $('<tr>')[0] );
                        rowData.appendChild($('<td>'+row['man'].range.replace(/\.0/g, '')+'</td>')[0]);
                        var maleData = rowData.appendChild( $('<td>')[0] );
                        var femaleData = rowData.appendChild( $('<td>')[0] );

                        var maleWoW = ESA.Utils.formatWoW(row['man'].revenue, data[data.length-2][idx]['man'].revenue);
                        var femaleWoW = ESA.Utils.formatWoW(row['woman'].revenue, data[data.length-2][idx]['woman'].revenue);

                        maleData.appendChild($('<td>&pound;'+row['man'].revenue+' <small>'+maleWoW+'</small></td>')[0]);
                        femaleData.appendChild($('<td>&pound;'+row['woman'].revenue+' <small>'+femaleWoW+'</small></td>')[0]);
                    })

                    $('#revenueDemographicsTable')[0].appendChild(fragment.cloneNode(true));


                    $('#revenueDemographicsPie').highcharts({
                        chart: {
                            type: 'pie',
                            height: 300
                        },

                        title: {
                            text: ""
                        },

                        series: [{
                            data: parsedData,
                            size: '75%',
                            dataLabels: {
                                formatter: function () {
                                    return this.y > 5 ? this.point.name : null;
                                },
                                color: 'white',
                                distance: -40
                            }
                        }, {
                            data: splitData,
                            size: '90%',
                            innerSize: '75%',
                            dataLabels: {
                                formatter: function () {
                                    return this.y > 1 ? '<b>' + this.point.name + '</b> ' : null;
                                },
                                distance: 10
                            }
                        }]
                    });

                })
            });
        })();
    </script>
}