@(title: String)

@main(title = title) {

    <h1 class="page-header">@title</h1>

    <div class="row">
        <div class="col-md-2">
            <dl>
                <dd><h2 class="top-none"><small>Revenue to date</small></h2></dd>
                <dt><h3 id="revenueMetric"></h3></dt>

                <dd><h2><small>WoW</small></h2></dd>
                <dt><h3 id="revenueWoW"></h3></dt>

                <dd><h2><small>MoM</small></h2></dd>
                <dt><h3 id="revenueMoM"></h3></dt>
            </dl>
        </div>
        <div class="col-md-10 top-spaced">
            <div id="revenueHistogram" style="min-width: 310px; height: 400px; margin: 0 auto"></div>
        </div>
    </div>

    <div class="row top-spaced">
        <div class="col-md-8">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Age Demographic</th>
                        <th>Male</th>
                        <th>Female</th>
                    </tr>
                </thead>
                <tbody id="revenueDemographicsTable"></tbody>
            </table>
        </div>
        <div class="col-md-4">
            <div id="revenueDemographicsPie"></div>
        </div>
    </div>

    <script>
        (function() {
            var endpoint = '/revenue/histogram';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(data) {
                    $('#revenueHistogram').highcharts('StockChart', {
                        navigator : {
                            enabled : false
                        },

                        rangeSelector : {
                            enabled : false
                        },

                        scrollbar : {
                            enabled : false
                        },

                        yAxis: {
                            min: 0
                        },

                        series : [data]
                    });
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/metric/1/2';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(data) {
                    $('#revenueMetric').html("&pound;" + data.data);
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/wow/1/2';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(num) {

                    if (num > 0) {
                        num = "+" + num
                    }

                    $('#revenueWoW').html(num + "%");
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/mom/1/2';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(num) {

                    if (num > 0) {
                        num = "+" + num
                    }

                    $('#revenueMoM').html(num + "%");
                })
            });
        })();

        (function() {
            var endpoint = '/revenue/demographics';
            $(function () {
                $.when(
                    ESA.Utils.jsonGet(endpoint, "")
                ).then(function(data) {
                    var colors = Highcharts.getOptions().colors;
                    var fragment = document.createDocumentFragment();

                    var splitData = [];

                    var parsedData = data.map(function(row, idx) {

                        row.map(function(cell){
                            splitData.push({
                                name: (cell.gender === "man" ? "Men" : "Women"),
                                y: cell.revenue,
                                color: colors[idx]
                            })
                        })

                        return {
                            name: row[0].range,
                            y: row[0].revenue + row[1].revenue,
                            color: colors[idx]
                        }
                    })

                    for(var i = 0, l = data.length; i < l; i++) {
                        var row = fragment.appendChild( $('<tr/>')[0] );
                        row.appendChild($('<td>'+data[i][0].range+'</td>')[0]);
                        data[i].map(function(segment) {
                            row.appendChild($('<td>&pound;'+segment.revenue+'</td>')[0]);
                        })
                    }

                    $('#revenueDemographicsTable')[0].appendChild(fragment.cloneNode(true));


                    $('#revenueDemographicsPie').highcharts({
                        chart: {
                            type: 'pie',
                            height: 300
                        },

                        title: {
                            text: ""
                        },

                        series: [{
                            data: parsedData,
                            size: '75%',
                            dataLabels: {
                                formatter: function () {
                                    return this.y > 5 ? this.point.name : null;
                                },
                                color: 'white',
                                distance: -40
                            }
                        }, {
                            data: splitData,
                            size: '90%',
                            innerSize: '75%',
                            dataLabels: {
                                formatter: function () {
                                    return this.y > 1 ? '<b>' + this.point.name + '</b> ' : null;
                                },
                                distance: 10
                            }
                        }]
                    });

                })
            });
        })();
    </script>
}